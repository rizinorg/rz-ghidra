
option(BUILD_DECOMPILE_EXECUTABLE "Build \"decompile\" executable as used by Ghidra (not needed for r2)" OFF)
option(BUILD_DECOMPILE_CLI_EXECUTABLE "Build REPL decompiler (not needed for r2)" OFF)

################################################################################
# see Ghidra/Features/Decompiler/build.gradle in Ghidra source

set(DECOMPILER_SOURCE_BASE_CXX
		# xml.cc				// generated by yacc task
		space.cc
		float.cc
		address.cc
		pcoderaw.cc
		translate.cc
		opcodes.cc
		globalcontext.cc
		capability.cc
		architecture.cc
		options.cc
		graph.cc
		cover.cc
		block.cc
		cast.cc
		typeop.cc
		database.cc
		cpool.cc
		comment.cc
		fspec.cc
		action.cc
		loadimage.cc
		# grammar.cc	 // doesn't seem to be used
		varnode.cc
		op.cc
		type.cc
		variable.cc
		varmap.cc
		jumptable.cc
		emulate.cc
		emulateutil.cc
		flow.cc
		userop.cc
		funcdata.cc
		funcdata_block.cc
		funcdata_varnode.cc
		funcdata_op.cc
		pcodeinject.cc
		heritage.cc
		prefersplit.cc
		rangeutil.cc
		ruleaction.cc
		subflow.cc
		blockaction.cc
		merge.cc
		double.cc
		coreaction.cc
		condexe.cc
		override.cc
		dynamic.cc
		crc32.cc
		prettyprint.cc
		printlanguage.cc
		printc.cc
		printjava.cc
		memstate.cc
		opbehavior.cc
		paramid.cc
		# callgraph.cc			// uncomment for debug
		# ifacedecomp.cc		// uncomment for debug
		# ifaceterm.cc			// uncomment for debug
		# interface.cc			// uncomment for debug
		)

set(DECOMPILER_SOURCE_BASE_YACC
		xml.y)

set(DECOMPILER_SOURCE_LIBDECOMP_CXX
		libdecomp.cc)

# Source specific to Ghidra
set(DECOMPILER_SOURCE_GHIDRA_CXX
		ghidra_process.cc
		ghidra_arch.cc
		loadimage_ghidra.cc
		typegrp_ghidra.cc
		database_ghidra.cc
		ghidra_context.cc
		cpool_ghidra.cc
		comment_ghidra.cc
		inject_ghidra.cc
		ghidra_translate.cc)

set(DECOMPILER_SOURCE_SLEIGH_CXX
		sleigh_arch.cc
		sleigh.cc
		inject_sleigh.cc
		filemanage.cc
		semantics.cc
		slghsymbol.cc
		context.cc
		sleighbase.cc
		slghpatexpress.cc
		slghpattern.cc
		pcodecompile.cc)

set(DECOMPILER_SOURCE_SLEIGH_YACC
		pcodeparse.y
		grammar.y)

set(DECOMPILER_SOURCE_CONSOLE_CXX
		consolemain.cc
		interface.cc
		ifacedecomp.cc
		ifaceterm.cc
		callgraph.cc
		raw_arch.cc)

set(DECOMPILER_SOURCE_DIR ghidra/Ghidra/Features/Decompiler/src/decompile/cpp)

################################################################################

list(TRANSFORM DECOMPILER_SOURCE_BASE_CXX PREPEND "${DECOMPILER_SOURCE_DIR}/")
list(TRANSFORM DECOMPILER_SOURCE_LIBDECOMP_CXX PREPEND "${DECOMPILER_SOURCE_DIR}/")
list(TRANSFORM DECOMPILER_SOURCE_GHIDRA_CXX PREPEND "${DECOMPILER_SOURCE_DIR}/")
list(TRANSFORM DECOMPILER_SOURCE_SLEIGH_CXX PREPEND "${DECOMPILER_SOURCE_DIR}/")
list(TRANSFORM DECOMPILER_SOURCE_CONSOLE_CXX PREPEND "${DECOMPILER_SOURCE_DIR}/")
set(SOURCE "${DECOMPILER_SOURCE_BASE_CXX}")

find_package(BISON REQUIRED)
file(MAKE_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/bison")

# build yacc files and append the output files to OUT_VAR
macro(build_bison OUT_VAR)
	foreach(yacc_file ${ARGN})
		get_filename_component(yacc_name "${yacc_file}" NAME_WE)
		if(BISON_VERSION VERSION_LESS 2.6)
			set(BISON_COMPILE_FLAGS "--name-prefix=${yacc_name}_")
		else()
			set(BISON_COMPILE_FLAGS "-Dapi.prefix={${yacc_name}}")
		endif()
		BISON_TARGET(${yacc_name}
				"${CMAKE_CURRENT_SOURCE_DIR}/${DECOMPILER_SOURCE_DIR}/${yacc_file}"
				"${CMAKE_CURRENT_BINARY_DIR}/bison/${yacc_name}.cpp"
				COMPILE_FLAGS ${BISON_COMPILE_FLAGS})
		list(APPEND ${OUT_VAR} "${BISON_${yacc_name}_OUTPUTS}")
	endforeach()
endmacro()

build_bison(SOURCE ${DECOMPILER_SOURCE_BASE_YACC})
build_bison(DECOMPILER_SOURCE_SLEIGH_CXX ${DECOMPILER_SOURCE_SLEIGH_YACC})

add_library(ghidra_decompiler_base STATIC ${SOURCE})
target_include_directories(ghidra_decompiler_base PUBLIC "${DECOMPILER_SOURCE_DIR}")
set_target_properties(ghidra_decompiler_base PROPERTIES POSITION_INDEPENDENT_CODE ON)

add_library(ghidra_libdecomp STATIC ${DECOMPILER_SOURCE_LIBDECOMP_CXX})
set_target_properties(ghidra_libdecomp PROPERTIES POSITION_INDEPENDENT_CODE ON)

add_library(ghidra_decompiler_sleigh STATIC ${DECOMPILER_SOURCE_SLEIGH_CXX})
target_include_directories(ghidra_decompiler_sleigh PUBLIC "${DECOMPILER_SOURCE_DIR}")
set_target_properties(ghidra_decompiler_sleigh PROPERTIES POSITION_INDEPENDENT_CODE ON)

# "decompile" executable as used by Ghidra
if(BUILD_DECOMPILE_EXECUTABLE)
	add_executable(ghidra_decompiler_exec ${DECOMPILER_SOURCE_GHIDRA_CXX})
	target_link_libraries(ghidra_decompiler_exec ghidra_decompiler_base)
	set_target_properties(ghidra_decompiler_exec PROPERTIES OUTPUT_NAME decompile)
endif()

if(BUILD_DECOMPILE_CLI_EXECUTABLE)
	add_executable(ghidra_decompiler_cli ${DECOMPILER_SOURCE_CONSOLE_CXX})
	target_link_libraries(ghidra_decompiler_cli ghidra_decompiler_base ghidra_libdecomp ghidra_decompiler_sleigh)
	set_target_properties(ghidra_decompiler_cli PROPERTIES OUTPUT_NAME decompile_cli)
endif()
